<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Binance Multi-TF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { background: #000; color: #ccc; font-family: sans-serif; padding: 20px; }
        
        /* Layout Header & Tombol */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .tf-selector button {
            background: #333; color: #fff; border: 1px solid #555; padding: 5px 15px; cursor: pointer;
        }
        .tf-selector button.active { background: #26a69a; border-color: #26a69a; font-weight: bold; }
        
        #chart-container { height: 500px; border: 1px solid #333; }
        #rsi-container { height: 150px; border: 1px solid #333; border-top: none; }
        .price-info { font-family: monospace; font-size: 16px; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="price-info">
            BTCUSDT <span id="tf-label" style="color:#26a69a">[1s]</span> | 
            Price: <span id="price" style="color:#fff">---</span> | 
            RSI: <span id="rsi" style="color:#f39c12">---</span>
        </div>
        <div class="tf-selector">
            <button onclick="switchTF(1)" id="btn-1" class="active">1s</button>
            <button onclick="switchTF(5)" id="btn-5">5s</button>
            <button onclick="switchTF(15)" id="btn-15">15s</button>
            <button onclick="switchTF(30)" id="btn-30">30s</button>
        </div>
    </div>

    <div id="chart-container"></div>
    <div id="rsi-container"></div>

    <script>
        // --- SETUP CHART ---
        const chartOptions = { 
            layout: { textColor: '#d1d4dc', background: { type: 'solid', color: 'black' } },
            grid: { vertLines: { color: '#222' }, horzLines: { color: '#222' } },
            timeScale: { timeVisible: true, secondsVisible: true },
            crosshair: { mode: 0 }
        };

        const chart = LightweightCharts.createChart(document.getElementById('chart-container'), chartOptions);
        const candleSeries = chart.addCandlestickSeries({
            upColor: '#26a69a', downColor: '#ef5350', borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350'
        });

        const rsiChart = LightweightCharts.createChart(document.getElementById('rsi-container'), {
            ...chartOptions, timeScale: { visible: false }
        });
        const rsiSeries = rsiChart.addLineSeries({ color: '#f39c12', lineWidth: 2 });
        rsiSeries.createPriceLine({ price: 70, color: '#ef5350', lineStyle: 2, axisLabelVisible: false });
        rsiSeries.createPriceLine({ price: 30, color: '#26a69a', lineStyle: 2, axisLabelVisible: false });

        // --- FIX ERROR SCROLL SYNC (SOLUSI BARU) ---
        chart.timeScale().subscribeVisibleLogicalRangeChange(range => {
            rsiChart.timeScale().setVisibleLogicalRange(range);
        });

        // --- LOGIKA SWITCHING ---
        let currentTF = 1;
        const socket = io();

        function switchTF(tf) {
            currentTF = tf;
            
            // Update UI Tombol
            document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${tf}`).classList.add('active');
            document.getElementById('tf-label').innerText = `[${tf}s]`;
            
            // Bersihkan Data Lama agar tidak tumpang tindih
            candleSeries.setData([]);
            rsiSeries.setData([]);
        }

        function processData(tf, type, data) {
            // HANYA proses data jika TF yang dikirim SAMA DENGAN yang sedang dipilih user
            if (tf !== currentTF) return;

            // Format Data
            const candle = { time: data.start_time, open: data.open, high: data.high, low: data.low, close: data.close };
            const rsi = { time: data.start_time, value: data.rsi };

            // Update Chart
            candleSeries.update(candle);
            if(data.rsi) rsiSeries.update(rsi);

            // Update Teks Header
            document.getElementById('price').innerText = data.close.toFixed(2);
            const rsiEl = document.getElementById('rsi');
            rsiEl.innerText = data.rsi ? data.rsi.toFixed(2) : '---';
            rsiEl.style.color = data.rsi >= 70 ? '#ef5350' : (data.rsi <= 30 ? '#26a69a' : '#f39c12');
        }

        // --- LISTENER SOCKET MULTI-CHANNEL ---
        // Kita mendengarkan semua saluran, tapi memfilter di fungsi processData
        [1, 5, 15, 30].forEach(tf => {
            socket.on(`update_${tf}s`, (msg) => processData(tf, 'update', msg));
            socket.on(`close_${tf}s`, (msg) => processData(tf, 'close', msg));
        });

    </script>
</body>
</html>