<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Binance Pro: Divergence Master</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { background: #0b0e11; color: #eaecef; font-family: -apple-system, sans-serif; margin: 0; padding: 20px; user-select: none; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: #1e2329; padding: 10px; border-radius: 6px; }
        select, input { background: #2b3139; color: #fcd535; border: 1px solid #474d57; padding: 5px 10px; border-radius: 4px; font-weight: bold; outline: none; cursor: pointer; }
        .btn { background: #2b3139; color: #eaecef; border: 1px solid #474d57; padding: 6px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; margin-left: 5px; transition: 0.2s; }
        .btn:hover { background: #474d57; }
        .btn.active { background: #fcd535; color: #1e2329; border-color: #fcd535; }
        .btn-danger { color: #f6465d; border-color: #f6465d; }
        .info { font-family: 'Roboto Mono', monospace; font-size: 14px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .val { font-weight: bold; }
        #main-container { display: flex; flex-direction: column; height: 80vh; position: relative; }
        #chart-div { flex: 3; border: 1px solid #2b3139; border-bottom: none; cursor: crosshair; }
        #rsi-div { flex: 1; border: 1px solid #2b3139; }
        #alarm-panel { display: none; background: #1e2329; border: 1px solid #474d57; padding: 15px; border-radius: 6px; margin-bottom: 10px; }
        .alarm-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .alarm-list { max-height: 150px; overflow-y: auto; margin-top: 10px; border-top: 1px solid #2b3139; }
        .alarm-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #2b3139; font-size: 13px; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: #2b3139; color: #fff; padding: 15px 20px; margin-bottom: 10px; border-left: 5px solid #fcd535; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); animation: slideIn 0.3s ease-out; display: flex; align-items: center; justify-content: space-between; min-width: 250px; }
        .toast.alert-high { border-left-color: #f6465d; } .toast.alert-low { border-left-color: #0ecb81; } .toast.alert-magic { border-left-color: #9b59b6; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        #measure-tooltip { display: none; position: absolute; z-index: 100; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px; color: white; background: rgba(0,0,0,0.8); pointer-events: none; border: 1px solid #474d57; white-space: pre-line; }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div class="top-bar">
        <div class="info">
            <select id="symbol-select" onchange="changeSymbol(this.value)"><option value="BTCUSDT">BTCUSDT</option><option value="1000PEPEUSDT">1000PEPEUSDT</option></select>
            <select id="timezone-select" onchange="changeTimezone(this.value)"><option value="America/New_York" selected>New York</option><option value="Asia/Jakarta">Jakarta</option></select>
            
            <button class="btn" id="btn-measure" onclick="toggleMeasure()">üìê Measure</button>
            <button class="btn" id="btn-alarm-toggle" onclick="toggleAlarmPanel()">üîî Alarms</button>
            <button class="btn" id="btn-smc" onclick="toggleSMC()">‚ö° SMC</button>
            <button class="btn" id="btn-ema" onclick="toggleEMA()">üìà EMA</button>
            
            <button class="btn" id="btn-div" onclick="toggleDiv()">üîÄ Div</button>
            <button class="btn active" id="btn-div-sound" onclick="toggleDivSound()">üîä Div Alert</button>

            <span>TF: <span id="tf-label" style="color:#fcd535">[1s]</span></span>
            <span>Price: <span id="price" class="val">---</span></span>
            <span>RSI: <span id="rsi" class="val">---</span></span>
        </div>
        <div class="tf-selector">
            <button onclick="changeTF(1)" id="btn-1" class="active btn">1s</button>
            <button onclick="changeTF(5)" id="btn-5" class="btn">5s</button>
            <button onclick="changeTF(15)" id="btn-15" class="btn">15s</button>
            <button onclick="changeTF(30)" id="btn-30" class="btn">30s</button>
            <button onclick="changeTF(45)" id="btn-45" class="btn">45s</button>
            <button onclick="changeTF(60)" id="btn-60" class="btn">1m</button>
        </div>
    </div>
    
    <div id="alarm-panel">
        <div style="margin-bottom:10px; font-weight:bold; color:#fcd535;">Add RSI Alarm</div>
        <div class="alarm-row">
            <select id="alarm-symbol"><option value="BTCUSDT">BTCUSDT</option><option value="1000PEPEUSDT">1000PEPEUSDT</option></select>
            <select id="alarm-tf"><option value="1">1s</option><option value="5">5s</option><option value="15">15s</option><option value="30">30s</option><option value="45">45s</option><option value="60">1m</option></select>
            <select id="alarm-cond"><option value=">">RSI ></option><option value="<">RSI <</option></select>
            <input type="number" id="alarm-val" placeholder="Value" style="width: 80px;">
            <select id="alarm-sound"><option value="beep">Beep</option><option value="bell">Bell</option></select>
            <button class="btn" onclick="addAlarm()">+ Add</button>
        </div>
        <div class="alarm-list" id="alarm-list-container"></div>
    </div>

    <div id="main-container">
        <div id="measure-tooltip"></div>
        <div id="chart-div"></div>
        <div id="rsi-div"></div>
    </div>

    <script>
        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        function playSound(type) { 
            if(audioCtx.state==='suspended')audioCtx.resume();
            const osc=audioCtx.createOscillator(), gn=audioCtx.createGain();
            osc.connect(gn); gn.connect(audioCtx.destination);
            
            if(type==='beep'){
                osc.type='sine'; osc.frequency.setValueAtTime(800,audioCtx.currentTime);
                gn.gain.setValueAtTime(0.1,audioCtx.currentTime); gn.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.1);
                osc.start(); osc.stop(audioCtx.currentTime+0.1);
            } else if(type==='bell'){
                osc.type='triangle'; osc.frequency.setValueAtTime(600,audioCtx.currentTime);
                gn.gain.setValueAtTime(0.1,audioCtx.currentTime); gn.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+1.5);
                osc.start(); osc.stop(audioCtx.currentTime+1.5);
            } else if(type==='magic'){ // SUARA KHUSUS DIVERGENCE (CHIME)
                osc.type='sine'; 
                osc.frequency.setValueAtTime(1000,audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(2000,audioCtx.currentTime+0.2); // Naik nadanya
                gn.gain.setValueAtTime(0.1,audioCtx.currentTime); 
                gn.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.5);
                osc.start(); osc.stop(audioCtx.currentTime+0.5);
                
                // Tambah harmonik biar magical
                const osc2=audioCtx.createOscillator(); const gn2=audioCtx.createGain();
                osc2.connect(gn2); gn2.connect(audioCtx.destination);
                osc2.type='square'; osc2.frequency.setValueAtTime(500,audioCtx.currentTime);
                gn2.gain.setValueAtTime(0.05,audioCtx.currentTime); gn2.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.6);
                osc2.start(); osc2.stop(audioCtx.currentTime+0.6);
            }
        }

        // --- CONFIG ---
        const symbolSettings = {"BTCUSDT": {precision:2,minMove:0.01}, "1000PEPEUSDT": {precision:7,minMove:0.0000001}};
        let currentTF=1, currentSymbol="BTCUSDT", currentTimezone="America/New_York";
        let smcEnabled = false, smcMarkersCache = [];
        let divEnabled = false, divMarkersCache = []; // CACHE DIVERGENCE
        let divSoundEnabled = true; // DEFAULT ON
        let emaEnabled = false;
        
        const socket = io();
        const timeFormatter = (ts) => new Date(ts*1000).toLocaleTimeString('en-US',{timeZone:currentTimezone,hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
        
        // --- CHART ---
        const chartProps = { layout:{backgroundColor:'#161a1e',textColor:'#848e9c'}, grid:{vertLines:{color:'#2b3139'},horzLines:{color:'#2b3139'}}, timeScale:{timeVisible:true,secondsVisible:true,borderColor:'#2b3139'}, localization:{timeFormatter:timeFormatter}, crosshair:{mode:1}, rightPriceScale:{autoScale:true,minimumWidth:75}};
        const chart = LightweightCharts.createChart(document.getElementById('chart-div'), chartProps);
        const volumeSeries = chart.addHistogramSeries({color:'#26a69a',priceFormat:{type:'volume'},priceScaleId:'',scaleMargins:{top:0.8,bottom:0}});
        const candleSeries = chart.addCandlestickSeries({upColor:'#0ecb81',downColor:'#f6465d',borderVisible:false,wickUpColor:'#0ecb81',wickDownColor:'#f6465d'});
        const ema50Series = chart.addLineSeries({ color: '#fcd535', lineWidth: 2, visible: false });
        const ema200Series = chart.addLineSeries({ color: '#9b59b6', lineWidth: 2, visible: false });
        const rsiChart = LightweightCharts.createChart(document.getElementById('rsi-div'), {...chartProps,timeScale:{visible:true,timeVisible:true,secondsVisible:true}});
        const rsiSeries = rsiChart.addLineSeries({color:'#fcd535',lineWidth:2});
        rsiSeries.createPriceLine({price:70,color:'#f6465d',lineStyle:2,axisLabelVisible:false});
        rsiSeries.createPriceLine({price:30,color:'#0ecb81',lineStyle:2,axisLabelVisible:false});
        function syncCharts(c1,c2){c1.timeScale().subscribeVisibleLogicalRangeChange(r=>{if(r)c2.timeScale().setVisibleLogicalRange(r)});c2.timeScale().subscribeVisibleLogicalRangeChange(r=>{if(r)c1.timeScale().setVisibleLogicalRange(r)});}
        syncCharts(chart,rsiChart);

        function changeTimezone(tz) { currentTimezone=tz; const loc={timeFormatter:timeFormatter}; chart.applyOptions({localization:loc}); rsiChart.applyOptions({localization:loc}); }
        
        // --- TOGGLES ---
        function toggleSMC() { smcEnabled=!smcEnabled; updateMarkers(); document.getElementById('btn-smc').classList.toggle('active', smcEnabled); }
        function toggleDiv() { divEnabled=!divEnabled; updateMarkers(); document.getElementById('btn-div').classList.toggle('active', divEnabled); }
        function toggleDivSound() { divSoundEnabled=!divSoundEnabled; document.getElementById('btn-div-sound').classList.toggle('active', divSoundEnabled); }
        function toggleEMA() { emaEnabled=!emaEnabled; const b=document.getElementById('btn-ema'); b.classList.toggle('active', emaEnabled); ema50Series.applyOptions({visible:emaEnabled}); ema200Series.applyOptions({visible:emaEnabled}); }

        // Fungsi Gabungan untuk update marker (SMC + DIV)
        function updateMarkers() {
            let allMarkers = [];
            if(smcEnabled) allMarkers = allMarkers.concat(smcMarkersCache);
            if(divEnabled) allMarkers = allMarkers.concat(divMarkersCache);
            candleSeries.setMarkers(allMarkers.sort((a,b)=>a.time-b.time));
        }

        // --- DATA HANDLER ---
        function requestData() {
            const s=symbolSettings[currentSymbol]||{precision:2,minMove:0.01};
            const f={precision:s.precision,minMove:s.minMove};
            candleSeries.applyOptions({priceFormat:f}); ema50Series.applyOptions({priceFormat:f}); ema200Series.applyOptions({priceFormat:f});
            candleSeries.setData([]); rsiSeries.setData([]); volumeSeries.setData([]); ema50Series.setData([]); ema200Series.setData([]);
            smcMarkersCache=[]; divMarkersCache=[];
            socket.emit('request_history', {symbol:currentSymbol, tf:currentTF});
        }
        function changeTF(tf) { currentTF=tf; document.querySelectorAll('.tf-selector button').forEach(b=>b.classList.remove('active')); document.getElementById(`btn-${tf}`).classList.add('active'); document.getElementById('tf-label').innerText=`[${tf==60?'1m':tf+'s'}]`; requestData(); }
        function changeSymbol(sym) { currentSymbol=sym; requestData(); }

        socket.on('history_response', (msg) => {
            if(msg.symbol!==currentSymbol || msg.tf!==currentTF) return;
            const c=[],r=[],v=[],e50=[],e200=[];
            msg.data.forEach(d=>{
                c.push({time:d.start_time,open:d.open,high:d.high,low:d.low,close:d.close});
                if(d.rsi!==null)r.push({time:d.start_time,value:d.rsi});
                v.push({time:d.start_time,value:d.volume,color:d.close>=d.open?'rgba(14,203,129,0.5)':'rgba(246,70,93,0.5)'});
                if(d.ema50)e50.push({time:d.start_time,value:d.ema50}); if(d.ema200)e200.push({time:d.start_time,value:d.ema200});
            });
            candleSeries.setData(c); rsiSeries.setData(r); volumeSeries.setData(v); ema50Series.setData(e50); ema200Series.setData(e200);
            smcMarkersCache = msg.smc || [];
            divMarkersCache = msg.div || [];
            updateMarkers();
            chart.timeScale().fitContent();
        });

        [1,5,15,30,45,60].forEach(tf => {
            // SMC Event
            socket.on(`smc_new_${tf}s`, (msg) => { 
                if(currentSymbol===msg.symbol && currentTF===tf){ smcMarkersCache.push(msg.marker); updateMarkers(); } 
            });
            // DIV Event (Marker + Alarm)
            socket.on(`divergence_new_${tf}s`, (msg) => { 
                if(currentSymbol===msg.symbol) {
                    // 1. Simpan Marker (Hanya tampil di chart jika TF sesuai)
                    if(currentTF === tf) {
                        divMarkersCache.push(msg.marker);
                        updateMarkers();
                    }
                    
                    // 2. Alert & Sound (Jalan terus walaupun beda TF)
                    if(divSoundEnabled) {
                        playSound('magic'); // Suara unik
                        const type = msg.marker.text.includes('Bull') ? 'alert-low' : 'alert-high';
                        showToast(`‚ö° ${msg.marker.text} Detected!<br>${msg.symbol} [${tf}s]`, 'alert-magic');
                    }
                }
            });

            const handleUpdate = (msg) => {
                if(currentTF===tf && currentSymbol===msg.symbol){
                    candleSeries.update({time:msg.start_time,open:msg.open,high:msg.high,low:msg.low,close:msg.close});
                    const isUp=msg.close>=msg.open;
                    volumeSeries.update({time:msg.start_time,value:msg.volume,color:isUp?'rgba(14,203,129,0.5)':'rgba(246,70,93,0.5)'});
                    if(msg.rsi!==null) rsiSeries.update({time:msg.start_time,value:msg.rsi});
                    if(msg.ema50) ema50Series.update({time:msg.start_time, value:msg.ema50});
                    if(msg.ema200) ema200Series.update({time:msg.start_time, value:msg.ema200});
                    const pEl=document.getElementById('price'); const s=symbolSettings[currentSymbol];
                    pEl.innerText=Number(msg.close).toFixed(s.precision); pEl.style.color=isUp?'#0ecb81':'#f6465d'; document.getElementById('rsi').innerText=msg.rsi?msg.rsi.toFixed(2):'--';
                }
                if(msg.rsi!==null) checkAlarms(msg.symbol,tf,msg.rsi);
            };
            socket.on(`update_${tf}s`, handleUpdate); socket.on(`close_${tf}s`, handleUpdate);
        });

        // UTILS
        let alarms=JSON.parse(localStorage.getItem('tradingAlarms'))||[];
        function toggleAlarmPanel(){const p=document.getElementById('alarm-panel');p.style.display=p.style.display==='block'?'none':'block';renderAlarms();}
        function addAlarm(){const sym=document.getElementById('alarm-symbol').value,tf=parseInt(document.getElementById('alarm-tf').value),cond=document.getElementById('alarm-cond').value,val=parseFloat(document.getElementById('alarm-val').value),sound=document.getElementById('alarm-sound').value;if(isNaN(val))return alert("Invalid");alarms.push({id:Date.now(),symbol:sym,tf:tf,cond:cond,val:val,sound:sound,lastTrigger:0});saveAlarms();renderAlarms();playSound(sound);showToast('Alarm Set','neutral');}
        function deleteAlarm(id){alarms=alarms.filter(a=>a.id!==id);saveAlarms();renderAlarms();}
        function saveAlarms(){localStorage.setItem('tradingAlarms',JSON.stringify(alarms));}
        function renderAlarms(){const c=document.getElementById('alarm-list-container');c.innerHTML='';alarms.forEach(a=>{const d=document.createElement('div');d.className='alarm-item';d.innerHTML=`<span>${a.symbol} [${a.tf==60?'1m':a.tf+'s'}] RSI ${a.cond} ${a.val}</span><button class="btn btn-danger" onclick="deleteAlarm(${a.id})">X</button>`;c.appendChild(d);});}
        function checkAlarms(s,t,r){const now=Date.now();alarms.forEach(a=>{if(a.symbol===s&&a.tf===t){if(now-a.lastTrigger<60000)return;if((a.cond==='>'&&r>a.val)||(a.cond==='<'&&r<a.val)){playSound(a.sound);showToast(`ALARM: ${s} RSI ${r.toFixed(2)}`,'alert-high');a.lastTrigger=now;saveAlarms();}}});}
        function showToast(m,t){const c=document.getElementById('toast-container'),d=document.createElement('div');d.className=`toast ${t}`;d.innerHTML=m;c.appendChild(d);setTimeout(()=>{d.remove()},5000);}
        let isM=false,mS=null;const mt=document.getElementById('measure-tooltip'),mb=document.getElementById('btn-measure');
        function toggleMeasure(){isM=!isM;mS=null;if(isM){mb.classList.add('active');mb.innerText="Start...";}else{mb.classList.remove('active');mb.innerText="Measure";mt.style.display='none';}}
        chart.subscribeClick(p=>{if(!isM||!p.point)return;const pr=candleSeries.coordinateToPrice(p.point.y);if(!pr)return;if(!mS){mS=pr;mb.innerText="End...";}else{const d=pr-mS,pct=(d/mS)*100,s=symbolSettings[currentSymbol];mt.innerHTML=`${pct.toFixed(2)}%<br>${d.toFixed(s.precision)}`;mt.style.left=(p.point.x+10)+'px';mt.style.top=(p.point.y+10)+'px';mt.style.display='block';isM=false;mS=null;mb.classList.remove('active');mb.innerText="Measure";}});
        
        renderAlarms(); changeTimezone(currentTimezone); requestData();
        window.addEventListener('resize', () => { chart.resize(document.getElementById('chart-div').clientWidth, document.getElementById('chart-div').clientHeight); rsiChart.resize(document.getElementById('rsi-div').clientWidth, document.getElementById('rsi-div').clientHeight); });
    </script>
</body>
</html>